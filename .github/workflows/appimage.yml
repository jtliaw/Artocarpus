name: Build Linux AppImage

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y fuse libfuse2 python3-pip
          pip install ttkthemes

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          cp adb AppDir/usr/bin/
          cp scrcpy AppDir/usr/bin/
          cp scrcpy_gui.py AppDir/usr/bin/
          cp scrcpy-server AppDir/usr/bin/
          cp icon.png AppDir/

          # 创建 AppRun 启动脚本
          cat <<EOF > AppDir/AppRun
          #!/bin/bash
          cd /usr/bin
          python3 scrcpy_gui.py "\$@"
          EOF
          chmod +x AppDir/AppRun

          # 创建 Desktop 文件
          cat <<EOF > AppDir/Artocarpus_scrcpy_gui.desktop
          [Desktop Entry]
          Name=Artocarpus Scrcpy GUI
          Exec=python3 scrcpy_gui.py
          Icon=icon
          Type=Application
          Categories=Utility;
          EOF

      - name: Download AppImageTool
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Build AppImage
        run: |
          VERSION="v5.0"
          BUILD_TIME="$(date +'%Y%m%d-%H%M%S')"
          ARCH="x86_64"
          FILE_NAME="Artocarpus_scrcpy_gui-${VERSION}-${BUILD_TIME}-${ARCH}.AppImage"
          ARCH=$ARCH ./appimagetool AppDir "$FILE_NAME"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV

      - name: Create Tag
        run: |
          TAG_NAME="${{ env.VERSION }}-${{ env.BUILD_TIME }}"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Artocarpus_scrcpy_gui ${{ env.VERSION }} 自动打包
          files: ${{ env.FILE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
